CONFIG_ZMK_SPLIT_ROLE_CENTRAL=y

############################################################
# Keyboard Identification / AroundFortyRB_R
############################################################

# ZMK 内部で使用されるキーボード名
CONFIG_ZMK_KEYBOARD_NAME="AroundFortyRB"

# Bluetooth デバイスとして OS に表示される名前
CONFIG_BT_DEVICE_NAME="AroundFortyRB"

# BLE デバイス名の最大長（nRF52 制約対策）
CONFIG_BT_DEVICE_NAME_MAX=16


############################################################
# Core ZMK Features
############################################################

# トラックボール・マウス入力機能を有効化
CONFIG_ZMK_POINTING=y

# Bluetooth LE キーボード機能
CONFIG_ZMK_BLE=y


############################################################
# nRF52840 Hardware Specific
############################################################

# NFC ピン（P0.09 / P0.10）を GPIO として再利用
# ※ NFC 機能は無効化される
CONFIG_NFCT_PINS_AS_GPIOS=y


############################################################
# Bluetooth (Zephyr BLE stack) Memory / Buffer Tuning
# BLE 接続の安定性向上・ペアリング失敗対策
############################################################

# Bluetooth RX 処理用スレッドのスタックサイズ（bytes）
# BLE 受信処理・イベント処理を行う Zephyr 内部スレッド用
# 値が小さいと：
#   - 広告が出ない
#   - ペアリング中に切断
#   - 接続直後に切れる
# Studio / Split BLE / Status Advertisement 使用時は 2048 推奨
CONFIG_BT_RX_STACK_SIZE=2048


# Bluetooth HCI TX（送信）処理用スタックサイズ（bytes）
# ホスト → コントローラへ送る BLE コマンド処理に使用
# 不足すると：
#   - ペアリング要求が送れない
#   - 接続確立直前で失敗
# 通常 1024 で十分だが、Split BLE 構成では必須
CONFIG_BT_HCI_TX_STACK_SIZE=1024


# Bluetooth ACL RX バッファサイズ（bytes）
# 接続後に受信する BLE データパケット 1個あたりの最大サイズ
# 251 = BLE の最大ペイロード（Data Length Extension 使用時）
# 小さいと：
#   - 接続はできるが通信が不安定
#   - キー入力やステータス同期が詰まる
CONFIG_BT_BUF_ACL_RX_SIZE=251


# Bluetooth ACL TX バッファサイズ（bytes）
# 接続後に送信する BLE データパケット 1個あたりの最大サイズ
# RX と同じく最大値 251 を指定しておくのが安全
# Split BLE / Status Advertisement / Battery Reporting で有効
CONFIG_BT_BUF_ACL_TX_SIZE=251

# BLE 試験的機能（AAAに合わせ無効化。macOS との相性を考慮）
CONFIG_ZMK_BLE_EXPERIMENTAL_FEATURES=n

# 接続パラメータの最適化 (AAA 準拠: 15ms 固定)
# 1.25ms * 12 = 15ms
CONFIG_BT_PERIPHERAL_PREF_MIN_INT=12
CONFIG_BT_PERIPHERAL_PREF_MAX_INT=12

# 出力パワーを最強に設定 (AAA準拠)
CONFIG_BT_CTLR_TX_PWR_PLUS_8=y

# スリープ機能を有効化 (AAA準拠: 30分でスリープ)
CONFIG_ZMK_SLEEP=y
CONFIG_ZMK_IDLE_TIMEOUT=30000
CONFIG_ZMK_IDLE_SLEEP_TIMEOUT=1800000

# Bluetooth 接続上限の明示的設定
# スプリットの子機用(1) + ホスト用(5) = 計6を想定
CONFIG_BT_MAX_CONN=6
CONFIG_BT_MAX_PAIRED=6



############################################################
# Zephyr Driver Subsystems
############################################################

# SPI バス（PMW3610 用）
CONFIG_SPI=y

# Zephyr Input subsystem（ZMK 入力基盤）
CONFIG_INPUT=y


############################################################
# PMW3610 ALT ドライバを使用
CONFIG_PMW3610=y

# ノイズ低減・微小移動補正などを行うスマートアルゴリズム
CONFIG_PMW3610_SMART_ALGORITHM=y

# PMW3610 センサーの報告間隔を通信間隔（15ms）と同期 (AAA準拠)
CONFIG_PMW3610_REPORT_INTERVAL_MIN=15
CONFIG_PMW3610_RUN_DOWNSHIFT_TIME_MS=3264
CONFIG_PMW3610_REST1_SAMPLE_TIME_MS=20
CONFIG_PMW3610_REST3_SAMPLE_TIME_MS=300
CONFIG_PMW3610_INIT_POWER_UP_EXTRA_DELAY_MS=1000


############################################################
# ZMK Studio (Debug / Visualization)
############################################################

# ZMK Studio 接続を有効化
CONFIG_ZMK_STUDIO=y

# Studio 接続時のロックを無効化（開発向け）
# 実運用では y にする選択肢もあり
CONFIG_ZMK_STUDIO_LOCKING=n


############################################################
# RGB LED Widget (Status Visualization)
############################################################

# RGB LED ウィジェットを有効化
CONFIG_RGBLED_WIDGET=y

# バッテリー残量がこの値以上なら通常表示（%）
CONFIG_RGBLED_WIDGET_BATTERY_LEVEL_HIGH=30

# バッテリー残量がこの値以下で警告表示（%）
CONFIG_RGBLED_WIDGET_BATTERY_LEVEL_CRITICAL=10

# レイヤー切り替え時に LED 表示を行う
CONFIG_RGBLED_WIDGET_SHOW_LAYER_CHANGE=y


############################################################
# Battery Reporting (Split Keyboard Support)
############################################################

# バッテリー残量のレポート機能
CONFIG_ZMK_BATTERY_REPORTING=y

# Central 側が Peripheral のバッテリーを代理表示
CONFIG_ZMK_SPLIT_BLE_CENTRAL_BATTERY_LEVEL_PROXY=y

# Central 側が Peripheral のバッテリー情報を取得
CONFIG_ZMK_SPLIT_BLE_CENTRAL_BATTERY_LEVEL_FETCHING=y

# Bluetooth Battery Service (BAS)
CONFIG_BT_BAS=y


############################################################
# Thread / Stack Size Tuning
# PMW3610 + RGB + Studio + Split + BLE 対策
############################################################

# BLE 処理用スレッドスタック
CONFIG_ZMK_BLE_THREAD_STACK_SIZE=2048

# 低優先度タスク用スタック
CONFIG_ZMK_LOW_PRIORITY_THREAD_STACK_SIZE=2048

# Input subsystem 用スタック
CONFIG_INPUT_THREAD_STACK_SIZE=2048

# Split Peripheral 側 BLE スタック
CONFIG_ZMK_SPLIT_BLE_PERIPHERAL_STACK_SIZE=2048

# Split Central 側ランタイム処理スタック
CONFIG_ZMK_SPLIT_BLE_CENTRAL_SPLIT_RUN_STACK_SIZE=3096


############################################################
# Bluetooth PHY Configuration
############################################################

# BLE 2M PHY を無効化（安定性優先）
CONFIG_BT_CTLR_PHY_2M=n

# 接続数上限（念のため左右で揃える）
CONFIG_BT_MAX_CONN=6
CONFIG_BT_MAX_PAIRED=6
